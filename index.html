<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">
    <title>Matematik Düellosu | Rekorlar Dünyası</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f0f2f5;
            --p1-color: #6c5ce7;
            --p2-color: #d63031;
            --success: #2ecc71;
            --success-hover: #27ae60;
            --warning: #f1c40f;
            --orange: #e67e22;
            --text: #2d3436;
            --accent: #0984e3;
            --gold: #f1c40f;
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .signature {
            position: fixed;
            bottom: 15px;
            right: 20px;
            font-size: 0.85rem;
            color: rgba(45, 52, 54, 0.4);
            font-weight: 600;
            letter-spacing: 1px;
            pointer-events: none;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .signature::before {
            content: '';
            width: 20px;
            height: 1px;
            background: rgba(45, 52, 54, 0.2);
            display: inline-block;
        }

        #setup-screen {
            position: fixed;
            inset: 0;
            background: white;
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }

        .setup-card {
            background: #fff;
            padding: 30px;
            border-radius: 30px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 600px;
            width: 100%;
        }

        .hall-of-fame {
            background: linear-gradient(135deg, #f1c40f, #e67e22);
            color: white;
            padding: 15px;
            border-radius: 20px;
            margin-bottom: 25px;
            display: none;
            animation: pulse-glow 2s infinite;
            border: 3px solid #fff;
            box-shadow: 0 5px 15px rgba(241, 196, 15, 0.4);
        }

        @keyframes pulse-glow {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .record-holder-name { font-weight: 800; font-size: 1.4rem; text-transform: uppercase; }
        .record-score { font-size: 1.1rem; opacity: 0.9; }
        .record-challenge { font-size: 0.9rem; font-style: italic; margin-top: 5px; font-weight: 600; }

        .setup-title { font-size: 2rem; margin-bottom: 20px; color: var(--p1-color); }
        .setup-group { margin-bottom: 20px; }
        .setup-label { display: block; margin-bottom: 8px; font-weight: 600; }

        .name-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .name-input-box { display: flex; flex-direction: column; text-align: left; }
        .name-input-box label { font-size: 0.85rem; margin-bottom: 5px; color: #636e72; font-weight: 600; }
        .name-input { padding: 12px; border: 2px solid #dfe6e9; border-radius: 12px; font-family: inherit; font-size: 1rem; outline: none; }

        .option-btns { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .opt-btn {
            padding: 10px 15px;
            border: 2px solid #dfe6e9;
            background: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
            flex: 1;
            min-width: 80px;
        }
        .opt-btn.active { border-color: var(--p1-color); background: var(--p1-color); color: white; }

        .start-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2rem;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 700;
            width: 100%;
            margin-top: 10px;
        }

        .history-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 15px;
            width: 100%;
        }

        #countdown-screen {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 150;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #countdown-text {
            font-size: 12rem;
            font-weight: 800;
            color: var(--p1-color);
            animation: bounceIn 1s forwards;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        #game-screen {
            display: none;
            height: 100%;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            background: #dfe6e9;
            padding: 20px;
        }

        .player-zone {
            background: white;
            display: flex;
            flex-direction: column;
            padding: 20px;
            border-radius: 25px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            touch-action: none; 
        }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .player-name { font-weight: 700; font-size: 1.1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; }
        .p1-name { color: var(--p1-color); }
        .p2-name { color: var(--p2-color); }

        .score-box {
            font-size: 1.4rem;
            font-weight: 700;
            background: #f1f2f6;
            padding: 5px 12px;
            border-radius: 10px;
        }

        .pass-indicator {
            font-size: 0.85rem;
            background: var(--orange);
            color: #fff;
            padding: 5px 10px;
            border-radius: 10px;
            font-weight: 600;
        }

        .question-box {
            background: #2d3436;
            color: white;
            border-radius: 20px;
            padding: 25px 10px;
            text-align: center;
            margin-bottom: 15px;
            transition: 0.2s;
        }

        .p1-q { background: var(--p1-color); }
        .p2-q { background: var(--p2-color); }
        .q-text { font-size: 2.2rem; font-weight: 700; }
        .a-display {
            font-size: 1.6rem;
            height: 40px;
            margin-top: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; flex-grow: 1; }
        .btn {
            border: none;
            border-radius: 15px;
            font-size: 1.4rem;
            font-weight: 700;
            cursor: pointer;
            background: #f1f2f6;
            transition: 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }
        .btn:active { transform: scale(0.95); background: #dfe6e9; }
        
        .btn-check { 
            grid-column: span 2; 
            background: var(--success); 
            color: white; 
            font-size: 1.1rem; 
            text-transform: uppercase;
            box-shadow: 0 4px 0 var(--success-hover);
            border-bottom: 4px solid var(--success-hover);
        }

        .btn-pass {
            background: var(--orange);
            color: white;
            font-size: 1.1rem;
            box-shadow: 0 4px 0 #d35400;
            border-bottom: 4px solid #d35400;
        }

        #timer-bar-container { height: 20px; background: #dfe6e9; width: 100%; overflow: hidden; border-bottom: 2px solid #999; }
        #timer-bar { 
            height: 100%; 
            background: var(--success); 
            width: 100%; 
            transition: width 1s linear, background-color 0.5s ease; 
        }

        @keyframes timer-blink {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }
        .urgent-timer { animation: timer-blink 0.5s infinite; }

        #result-screen, #leaderboard-screen {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 200;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            overflow: hidden;
            padding: 20px;
        }

        @keyframes winner-pulse {
            0% { transform: scale(1); filter: drop-shadow(0 0 10px var(--gold)); }
            50% { transform: scale(1.15); filter: drop-shadow(0 0 30px var(--gold)); }
            100% { transform: scale(1); filter: drop-shadow(0 0 10px var(--gold)); }
        }

        @keyframes bg-glow {
            0%, 100% { background: radial-gradient(circle, rgba(241, 196, 15, 0.2) 0%, rgba(0,0,0,1) 70%); }
            50% { background: radial-gradient(circle, rgba(241, 196, 15, 0.4) 0%, rgba(0,0,0,1) 80%); }
        }

        .winner-animation {
            animation: winner-pulse 1.5s infinite ease-in-out;
            text-shadow: 0 0 20px rgba(241, 196, 15, 0.8);
        }

        .result-glow {
            position: absolute;
            inset: 0;
            z-index: -1;
            animation: bg-glow 3s infinite;
        }

        .motivation-msg {
            font-size: 1.2rem;
            color: #bdc3c7;
            margin-top: 10px;
            font-style: italic;
            max-width: 80%;
        }

        .leaderboard-content {
            background: white;
            width: 100%;
            max-width: 800px;
            max-height: 80vh;
            border-radius: 30px;
            padding: 30px;
            color: var(--text);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .table-container { overflow-y: auto; flex-grow: 1; }
        table { width: 100%; border-collapse: collapse; text-align: left; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; }
        th { font-weight: 700; color: #636e72; position: sticky; top: 0; background: white; }
        .king-crown { color: var(--gold); font-size: 1.4rem; vertical-align: middle; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
        .wrong { animation: shake 0.3s; background: #ff7675 !important; }

        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .correct { animation: pop 0.4s; background: var(--success) !important; }

        @media (max-width: 800px) {
            #game-screen { grid-template-columns: 1fr; gap: 20px; overflow-y: auto; }
            #countdown-text { font-size: 8rem; }
        }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="signature">Sami G.</div>

<div id="setup-screen">
    <div class="setup-card">
        <div class="hall-of-fame" id="hall-of-fame">
            <div>👑 ŞU ANKİ REKOR ONDA! 👑</div>
            <div class="record-holder-name" id="record-holder">KİMSE</div>
            <div class="record-score" id="record-score-val">Skor: 0</div>
            <div class="record-challenge">Bu rekoru kırmaya var mısın?</div>
        </div>

        <h1 class="setup-title">Matematik Düellosu</h1>
        
        <div class="setup-group">
            <span class="setup-label">Öğrenci İsimleri (Opsiyonel)</span>
            <div class="name-inputs">
                <div class="name-input-box">
                    <label>1. Oyuncu</label>
                    <input class="name-input" id="p1-name-input" placeholder="Oyuncu 1" type="text" />
                </div>
                <div class="name-input-box">
                    <label>2. Oyuncu</label>
                    <input class="name-input" id="p2-name-input" placeholder="Oyuncu 2" type="text" />
                </div>
            </div>
        </div>

        <div class="setup-group">
            <span class="setup-label">İşlemler</span>
            <div class="option-btns">
                <button class="opt-btn active" onclick="toggleOp('+', this)">Toplama</button>
                <button class="opt-btn active" onclick="toggleOp('-', this)">Çıkarma</button>
                <button class="opt-btn" onclick="toggleOp('*', this)">Çarpma</button>
                <button class="opt-btn" onclick="toggleOp('/', this)">Bölme</button>
            </div>
        </div>

        <div class="setup-group">
            <span class="setup-label">Süre</span>
            <div class="option-btns">
                <button class="opt-btn" onclick="setTimer(30, this)">30 Sn</button>
                <button class="opt-btn active" onclick="setTimer(60, this)">60 Sn</button>
                <button class="opt-btn" onclick="setTimer(120, this)">120 Sn</button>
            </div>
        </div>

        <div class="setup-group">
            <span class="setup-label">Zorluk</span>
            <div class="option-btns">
                <button class="opt-btn active" onclick="setDiff(1, this)">Kolay</button>
                <button class="opt-btn" onclick="setDiff(2, this)">Orta</button>
                <button class="opt-btn" onclick="setDiff(3, this)">Zor</button>
            </div>
        </div>

        <button class="start-btn" onclick="startCountdown()">YARIŞMAYI BAŞLAT</button>
        <button class="history-btn" onclick="toggleLeaderboard(true)">SKOR KAYITLARI & REKORLAR</button>
    </div>
</div>

<div id="countdown-screen">
    <div id="countdown-text">3</div>
</div>

<div id="leaderboard-screen">
    <div class="leaderboard-content">
        <h2 style="margin-bottom: 20px;">🏆 Yarışma Efsaneleri 🏆</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr><th>Sıra</th><th>Oyuncular</th><th>Skorlar</th><th>Kazanan</th></tr>
                </thead>
                <tbody id="leaderboard-body"></tbody>
            </table>
        </div>
        <button class="start-btn" onclick="toggleLeaderboard(false)" style="margin-top: 20px;">KAPAT</button>
    </div>
</div>

<div id="timer-bar-container">
    <div id="timer-bar"></div>
</div>

<div id="game-screen">
    <div class="player-zone" id="zone-1">
        <div class="header">
            <div class="player-name p1-name" id="p1-display-name">OYUNCU 1</div>
            <div style="display:flex; gap:10px; align-items:center;">
                <div class="pass-indicator">PAS: <span id="p1-pass-count">3</span></div>
                <div class="score-box" id="p1-score">0</div>
            </div>
        </div>
        <div class="question-box p1-q" id="p1-qbox">
            <div class="q-text" id="p1-qtext">-</div>
            <div class="a-display" id="p1-adisplay"></div>
        </div>
        <div class="numpad">
            <button class="btn" data-val="1">1</button>
            <button class="btn" data-val="2">2</button>
            <button class="btn" data-val="3">3</button>
            <button class="btn" data-val="4">4</button>
            <button class="btn" data-val="5">5</button>
            <button class="btn" data-val="6">6</button>
            <button class="btn" data-val="7">7</button>
            <button class="btn" data-val="8">8</button>
            <button class="btn" data-val="9">9</button>
            <button class="btn btn-del" data-val="C">C</button>
            <button class="btn" data-val="0">0</button>
            <button class="btn" data-val="-">-</button>
            <button class="btn btn-check" data-val="CHECK">KONTROL ET</button>
            <button class="btn btn-pass" id="p1-pass-btn" data-val="PASS">PAS</button>
        </div>
    </div>

    <div class="player-zone" id="zone-2">
        <div class="header">
            <div class="player-name p2-name" id="p2-display-name">OYUNCU 2</div>
            <div style="display:flex; gap:10px; align-items:center;">
                <div class="pass-indicator">PAS: <span id="p2-pass-count">3</span></div>
                <div class="score-box" id="p2-score">0</div>
            </div>
        </div>
        <div class="question-box p2-q" id="p2-qbox">
            <div class="q-text" id="p2-qtext">-</div>
            <div class="a-display" id="p2-adisplay"></div>
        </div>
        <div class="numpad">
            <button class="btn" data-val="1">1</button>
            <button class="btn" data-val="2">2</button>
            <button class="btn" data-val="3">3</button>
            <button class="btn" data-val="4">4</button>
            <button class="btn" data-val="5">5</button>
            <button class="btn" data-val="6">6</button>
            <button class="btn" data-val="7">7</button>
            <button class="btn" data-val="8">8</button>
            <button class="btn" data-val="9">9</button>
            <button class="btn btn-del" data-val="C">C</button>
            <button class="btn" data-val="0">0</button>
            <button class="btn" data-val="-">-</button>
            <button class="btn btn-check" data-val="CHECK">KONTROL ET</button>
            <button class="btn btn-pass" id="p2-pass-btn" data-val="PASS">PAS</button>
        </div>
    </div>
</div>

<div id="result-screen">
    <div class="result-glow"></div>
    <div id="winner-trophy" style="font-size: 5rem; margin-bottom: 10px;">🏆</div>
    <h1 id="winner-msg" class="winner-animation" style="color:var(--gold); font-size:3.5rem">KAZANAN</h1>
    <p id="final-stats" style="font-size:1.5rem; margin:10px 0; color: #fff; font-weight: 600;"></p>
    <p id="motivation-text" class="motivation-msg"></p>
    <button class="start-btn" onclick="resetGame()" style="max-width:250px; box-shadow: 0 0 20px var(--success); margin-top: 20px;">YENİ YARIŞMA</button>
</div>

<script>
    let config = { time: 60, difficulty: 1, allowedOps: ['+', '-'] };
    let sessionHistory = [];
    let currentRecord = { name: "KİMSE", score: 0 };
    
    const motivationSentences = [
        "Unutma, her büyük usta bir zamanlar yeni başlayan bir öğrenciydi!",
        "Vazgeçme! Bir sonraki yarışmada zafer senin olabilir.",
        "Harika bir mücadeleydi! Pes etmeyenler her zaman kazanır.",
        "Rakamlarla dans etmeyi öğreniyorsun, azmin elinden hiçbir şey kurtulamaz.",
        "Bugün öğrenen, yarın yöneten olur. Çalışmaya devam!",
        "Skor sadece bir sayıdır, önemli olan her seferinde daha iyisini yapmak!",
        "Zihin kaslarını geliştirmeye devam et, yakında rekorları alt üst edeceksin.",
        "Yenilgi yoktur, sadece öğrenmek vardır. Bir kez daha dene!",
        "Hızın ve zekan gelişiyor, sadece biraz daha pratikle zirve senin.",
        "Büyük başarılar, küçük adımlarla başlar. Bugün harika bir adım attın!"
    ];

    let gameState = {
        p1: { name: "Oyuncu 1", score: 0, ans: 0, input: "", passes: 3 },
        p2: { name: "Oyuncu 2", score: 0, ans: 0, input: "", passes: 3 },
        timeLeft: 60, active: false
    };

    function setupTouchSupport() {
        [1, 2].forEach(p => {
            const zone = document.getElementById(`zone-${p}`);
            zone.addEventListener('touchstart', (e) => {
                const target = e.target;
                if (target.classList.contains('btn')) {
                    e.preventDefault();
                    const val = target.getAttribute('data-val');
                    handleInput(p, val);
                }
            }, { passive: false });
            zone.addEventListener('click', (e) => {
                const target = e.target;
                if (target.classList.contains('btn')) {
                    handleInput(p, target.getAttribute('data-val'));
                }
            });
        });
    }

    function handleInput(p, val) {
        if (!gameState.active) return;
        let ps = gameState[`p${p}`];
        if (val === 'PASS') usePass(p);
        else if (val === 'CHECK') check(p);
        else if (val === 'C') ps.input = "";
        else if (val === '-') { if (ps.input === "") ps.input = "-"; }
        else if (ps.input.length < 7) ps.input += val;
        document.getElementById(`p${p}-adisplay`).textContent = ps.input;
    }

    function toggleOp(op, btn) {
        if (btn.classList.contains('active')) {
            if (config.allowedOps.length > 1) {
                config.allowedOps = config.allowedOps.filter(o => o !== op);
                btn.classList.remove('active');
            }
        } else {
            config.allowedOps.push(op);
            btn.classList.add('active');
        }
    }

    function setTimer(val, btn) {
        config.time = val;
        btn.parentElement.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function setDiff(val, btn) {
        config.difficulty = val;
        btn.parentElement.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function startCountdown() {
        document.getElementById('setup-screen').style.display = 'none';
        const scr = document.getElementById('countdown-screen');
        const txt = document.getElementById('countdown-text');
        scr.style.display = 'flex';
        let c = 3;
        
        const countdownLoop = () => {
            txt.style.animation = 'none';
            void txt.offsetWidth; // trigger reflow
            txt.textContent = c;
            txt.style.animation = 'bounceIn 1s forwards';
            
            setTimeout(() => {
                c--;
                if (c > 0) {
                    countdownLoop();
                } else {
                    txt.style.animation = 'none';
                    void txt.offsetWidth;
                    txt.style.color = 'var(--success)';
                    txt.textContent = "BAŞLA!";
                    txt.style.animation = 'bounceIn 0.8s forwards';
                    setTimeout(() => {
                        scr.style.display = 'none';
                        startGame();
                        txt.style.color = 'var(--p1-color)'; // reset for next time
                    }, 800);
                }
            }, 1000);
        };
        
        countdownLoop();
    }

    function startGame() {
        gameState.p1.name = document.getElementById('p1-name-input').value.trim() || "Oyuncu 1";
        gameState.p2.name = document.getElementById('p2-name-input').value.trim() || "Oyuncu 2";
        document.getElementById('p1-display-name').textContent = gameState.p1.name.toUpperCase();
        document.getElementById('p2-display-name').textContent = gameState.p2.name.toUpperCase();
        document.getElementById('game-screen').style.display = 'grid';
        gameState.timeLeft = config.time;
        gameState.active = true;
        generateQuestion(1);
        generateQuestion(2);
        
        const bar = document.getElementById('timer-bar');
        bar.style.backgroundColor = 'var(--success)';
        bar.classList.remove('urgent-timer');

        const loop = setInterval(() => {
            if (!gameState.active) { clearInterval(loop); return; }
            gameState.timeLeft--;
            
            const percentage = (gameState.timeLeft / config.time) * 100;
            bar.style.width = percentage + "%";
            
            if (percentage > 50) bar.style.backgroundColor = 'var(--success)';
            else if (percentage > 25) bar.style.backgroundColor = 'var(--warning)';
            else bar.style.backgroundColor = 'var(--p2-color)';

            if (gameState.timeLeft <= 5 && gameState.timeLeft > 0) bar.classList.add('urgent-timer');

            if (gameState.timeLeft <= 0) {
                bar.style.width = "0%";
                endGame();
            }
        }, 1000);
    }

    function generateQuestion(p) {
        const ops = config.allowedOps;
        const op = ops[Math.floor(Math.random() * ops.length)];
        let n1, n2, ans, symbol = op;
        const mult = config.difficulty * 12;
        if (op === '+') { n1 = Math.floor(Math.random() * mult) + 2; n2 = Math.floor(Math.random() * mult) + 2; ans = n1 + n2; }
        else if (op === '-') { n1 = Math.floor(Math.random() * mult) + 10; n2 = Math.floor(Math.random() * (n1 - 1)) + 1; ans = n1 - n2; }
        else if (op === '*') { n1 = Math.floor(Math.random() * (config.difficulty * 4 + 4)) + 2; n2 = Math.floor(Math.random() * (config.difficulty * 4 + 4)) + 2; ans = n1 * n2; symbol = 'x'; }
        else { let res = Math.floor(Math.random() * (config.difficulty * 5 + 3)) + 2; n2 = Math.floor(Math.random() * (config.difficulty * 3 + 2)) + 2; n1 = res * n2; ans = res; symbol = ':'; }
        gameState[`p${p}`].ans = ans;
        gameState[`p${p}`].input = "";
        document.getElementById(`p${p}-qtext`).textContent = `${n1} ${symbol} ${n2}`;
        document.getElementById(`p${p}-adisplay`).textContent = "";
    }

    function check(p) {
        const ps = gameState[`p${p}`];
        if (ps.input === "" || ps.input === "-") return;
        const box = document.getElementById(`p${p}-qbox`);
        if (parseInt(ps.input) === ps.ans) {
            ps.score += (config.difficulty * 10);
            document.getElementById(`p${p}-score`).textContent = ps.score;
            box.classList.add('correct');
            setTimeout(() => {
                box.classList.remove('correct');
                generateQuestion(p);
            }, 300);
        } else {
            box.classList.add('wrong');
            ps.input = "";
            document.getElementById(`p${p}-adisplay`).textContent = "";
            setTimeout(() => box.classList.remove('wrong'), 300);
        }
    }

    function usePass(p) {
        if (gameState[`p${p}`].passes > 0) {
            gameState[`p${p}`].passes--;
            document.getElementById(`p${p}-pass-count`).textContent = gameState[`p${p}`].passes;
            generateQuestion(p);
        }
    }

    function endGame() {
        gameState.active = false;
        const p1 = gameState.p1.score;
        const p2 = gameState.p2.score;
        let win = p1 > p2 ? gameState.p1.name : (p2 > p1 ? gameState.p2.name : "Berabere");
        
        if (p1 > currentRecord.score) currentRecord = { name: gameState.p1.name, score: p1 };
        if (p2 > currentRecord.score) currentRecord = { name: gameState.p2.name, score: p2 };

        if (currentRecord.score > 0) {
            document.getElementById('hall-of-fame').style.display = 'block';
            document.getElementById('record-holder').textContent = currentRecord.name;
            document.getElementById('record-score-val').textContent = "Skor: " + currentRecord.score;
        }

        sessionHistory.push({ p1: { ...gameState.p1 }, p2: { ...gameState.p2 }, winner: win });
        
        const winMsg = document.getElementById('winner-msg');
        const winTrophy = document.getElementById('winner-trophy');
        const motivationEl = document.getElementById('motivation-text');
        
        // Random Motivation
        motivationEl.textContent = motivationSentences[Math.floor(Math.random() * motivationSentences.length)];

        if (win === "Berabere") {
            winMsg.textContent = "DOSTLUK KAZANDI! 🤝";
            winMsg.style.color = "#fff";
            winTrophy.textContent = "🤝";
            winMsg.classList.remove('winner-animation');
        } else {
            winMsg.textContent = win.toUpperCase() + " KAZANDI! 🏆";
            winMsg.style.color = "var(--gold)";
            winTrophy.textContent = "🏆";
            winMsg.classList.add('winner-animation');
        }
        
        document.getElementById('final-stats').textContent = `${gameState.p1.name}: ${p1} PUAN | ${gameState.p2.name}: ${p2} PUAN`;
        document.getElementById('result-screen').style.display = 'flex';
    }

    function resetGame() {
        gameState.p1.score = 0; gameState.p1.passes = 3;
        gameState.p2.score = 0; gameState.p2.passes = 3;
        document.getElementById('p1-score').textContent = "0";
        document.getElementById('p2-score').textContent = "0";
        document.getElementById('p1-pass-count').textContent = "3";
        document.getElementById('p2-pass-count').textContent = "3";
        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'none';
        document.getElementById('setup-screen').style.display = 'flex';
        const bar = document.getElementById('timer-bar');
        bar.style.width = "100%";
        bar.style.backgroundColor = 'var(--success)';
        bar.classList.remove('urgent-timer');
    }

    function toggleLeaderboard(show) {
        const scr = document.getElementById('leaderboard-screen');
        scr.style.display = show ? 'flex' : 'none';
        if (show) {
            const body = document.getElementById('leaderboard-body');
            body.innerHTML = sessionHistory.map((m, i) => {
                const isWinnerKing = (m.winner !== "Berabere" && (m.p1.score === currentRecord.score || m.p2.score === currentRecord.score));
                return `
                <tr>
                    <td>${i+1}. Maç</td>
                    <td>${m.p1.name} vs ${m.p2.name}</td>
                    <td>${m.p1.score} - ${m.p2.score}</td>
                    <td><strong>${m.winner}</strong> ${isWinnerKing ? '<span class="king-crown">👑</span>' : ''}</td>
                </tr>
            `;}).join('') || "<tr><td colspan='4' style='text-align:center'>Kayıtlı maç bulunamadı.</td></tr>";
        }
    }

    window.onload = setupTouchSupport;
</script>
</body>

</html>
